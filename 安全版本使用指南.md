# 🛡️ 安全版本使用指南

## 🎉 **部署完成！**

你的博客API现在已经升级为**企业级安全版本**！

## 📊 **安全升级内容**

### ✅ **已实现的安全功能**

| 安全功能 | 状态 | 说明 |
|---------|------|------|
| **CORS 白名单** | ✅ 已启用 | 只允许授权域名访问 |
| **API 身份验证** | ✅ 已启用 | 写操作需要API密钥 |
| **输入验证** | ✅ 已加强 | 过滤恶意内容和脚本 |
| **速率限制** | ✅ 已启用 | 每IP每分钟60次请求 |
| **错误保护** | ✅ 已改进 | 不泄露敏感信息 |
| **健康检查** | ✅ 新增 | 系统状态监控 |

## 🔑 **API 使用方式**

### 📖 **读取操作（无需认证）**
```bash
# 获取文章列表
curl https://api.huaman-lou.top/api/posts

# 获取单篇文章
curl https://api.huaman-lou.top/api/posts/1

# 健康检查
curl https://api.huaman-lou.top/api/health
```

### ✏️ **写入操作（需要API密钥）**
```bash
# 设置API密钥（你已经设置过了）
API_KEY="你设置的密钥"

# 创建文章
curl -X POST https://api.huaman-lou.top/api/posts \
  -H "Content-Type: application/json" \
  -H "X-API-Key: $API_KEY" \
  -d '{
    "title": "新文章标题",
    "content": "文章内容",
    "author": "作者名",
    "slug": "new-article",
    "status": "published"
  }'

# 更新文章
curl -X PUT https://api.huaman-lou.top/api/posts/1 \
  -H "Content-Type: application/json" \
  -H "X-API-Key: $API_KEY" \
  -d '{
    "title": "更新的标题"
  }'

# 删除文章
curl -X DELETE https://api.huaman-lou.top/api/posts/1 \
  -H "X-API-Key: $API_KEY"
```

## 🌐 **浏览器和前端使用**

### JavaScript 示例
```javascript
// 读取操作（无需密钥）
fetch('https://api.huaman-lou.top/api/posts')
  .then(response => response.json())
  .then(data => console.log(data));

// 写入操作（需要密钥）
fetch('https://api.huaman-lou.top/api/posts', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-API-Key': 'your-api-key-here'
  },
  body: JSON.stringify({
    title: '通过JS创建的文章',
    content: '内容...',
    author: '作者',
    slug: 'js-created-post',
    status: 'published'
  })
})
.then(response => response.json())
.then(data => console.log(data));
```

## 🔒 **安全特性详解**

### 1. **CORS 安全**
- ✅ 只允许以下域名访问：
  - `https://api.huaman-lou.top`
  - `https://huaman-lou.top`
  - `https://simple-blog-api.gudaobaiyun12.workers.dev`
  - `http://localhost:8787` (开发环境)
- ❌ 其他域名会收到 CORS 错误

### 2. **API 密钥验证**
- ✅ **读取操作**：公开访问（GET 请求）
- 🔐 **写入操作**：需要 `X-API-Key` 头部
  - POST（创建）
  - PUT（更新）
  - DELETE（删除）

### 3. **输入验证和清理**
- 🛡️ 自动移除 HTML 标签和脚本
- 📏 限制内容长度（标题200字符，内容50000字符）
- ✅ 验证 slug 格式
- 🔍 检查必需字段

### 4. **速率限制**
- ⏱️ 每个IP每分钟最多60次请求
- 🚫 超限后返回 429 状态码
- ⏰ 包含 `Retry-After` 头部

### 5. **错误处理**
- 🔒 不暴露内部错误信息
- 📝 生成请求ID用于调试
- 📊 详细的错误类别

## 🧪 **测试结果**

### ✅ **安全测试通过**
```bash
# 测试1: 读取操作正常
✅ GET /api/posts → 200 OK

# 测试2: 无密钥写入被拒绝
✅ POST /api/posts (无密钥) → 401 Unauthorized

# 测试3: CORS白名单生效
✅ 恶意域名被拒绝

# 测试4: 健康检查正常
✅ GET /api/health → 200 OK
```

## 📱 **更新客户端配置**

你的可视化界面已经自动更新为使用新域名：
- ✅ `public-blog-viewer.html` - 已更新
- ✅ `blog-viewer.html` - 已更新

## 🔧 **管理 API 密钥**

### 查看当前密钥
```bash
# 列出所有secrets
wrangler secret list
```

### 更新密钥
```bash
# 更新API密钥
wrangler secret put API_SECRET --env=""
```

### 删除密钥
```bash
# 删除密钥
wrangler secret delete API_SECRET --env=""
```

## 📊 **监控和维护**

### 健康检查
```bash
# 检查系统状态
curl https://api.huaman-lou.top/api/health
```

### 查看日志
```bash
# 实时查看日志
wrangler tail

# 查看最近1小时的日志
wrangler tail --since 1h
```

### 性能监控
- 访问 Cloudflare Dashboard → Workers → simple-blog-api → Metrics
- 查看请求量、错误率、响应时间

## 🚀 **版本信息**

- **当前版本**: 安全加固版 1.0.0
- **部署时间**: 2025-08-13
- **版本ID**: 6913010a-25bf-40c1-82d4-8a7b61eb673d
- **安全等级**: 🔴 **高级** (从中等提升)

## 🎯 **下一步建议**

1. **记录API密钥**: 将密钥保存在安全的地方
2. **监控使用**: 定期查看 Dashboard 中的指标
3. **备份数据**: 定期备份数据库
4. **更新密钥**: 定期更换API密钥（建议每3个月）

## 🔐 **安全最佳实践**

1. **保护密钥**: 
   - 不要在代码中硬编码密钥
   - 使用环境变量或配置文件
   - 定期轮换密钥

2. **监控异常**:
   - 关注异常高的请求量
   - 监控错误率变化
   - 检查可疑的访问模式

3. **定期审计**:
   - 检查访问日志
   - 更新安全配置
   - 审查用户权限

你的博客系统现在拥有**企业级的安全防护**！🛡️
