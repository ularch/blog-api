# Cloudflare D1 æµ‹è¯•éªŒè¯æŒ‡å—

## å‰ç½®æ¡ä»¶æ£€æŸ¥

### 1. ç¯å¢ƒè¦æ±‚éªŒè¯
åœ¨å¼€å§‹æµ‹è¯•ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

```bash
# æ£€æŸ¥ Node.js ç‰ˆæœ¬ï¼ˆéœ€è¦ >= 18.0.0ï¼‰
node --version

# æ£€æŸ¥ npm ç‰ˆæœ¬
npm --version

# æ£€æŸ¥ Wrangler CLI æ˜¯å¦å®‰è£…
npx wrangler --version

# å¦‚æœæœªå®‰è£…ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤
npm install -g @cloudflare/wrangler
```

### 2. Cloudflare è´¦æˆ·éªŒè¯
```bash
# ç™»å½• Cloudflareï¼ˆå¦‚æœæœªç™»å½•ï¼‰
npx wrangler login

# éªŒè¯ç™»å½•çŠ¶æ€
npx wrangler whoami

# æ£€æŸ¥è´¦æˆ·æƒé™
npx wrangler d1 list
```

## åˆ†æ­¥æµ‹è¯•æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šæœ¬åœ°ç¯å¢ƒæµ‹è¯•

#### 1.1 åˆ›å»ºå’Œé…ç½® D1 æ•°æ®åº“
```bash
# åˆ›å»ºæ–°çš„ D1 æ•°æ®åº“
npx wrangler d1 create simple-blog-db

# è¾“å‡ºç¤ºä¾‹ï¼š
# âœ… Successfully created DB 'simple-blog-db'
# [[d1_databases]]
# binding = "DB"
# database_name = "simple-blog-db"
# database_id = "your-database-id-here"
```

**é‡è¦ï¼š** å¤åˆ¶è¾“å‡ºçš„ `database_id` å¹¶æ›´æ–°åˆ° `wrangler.toml` æ–‡ä»¶ä¸­ã€‚

#### 1.2 éªŒè¯æ•°æ®åº“åˆ›å»º
```bash
# æŸ¥çœ‹æ•°æ®åº“åˆ—è¡¨
npx wrangler d1 list

# æŸ¥çœ‹ç‰¹å®šæ•°æ®åº“ä¿¡æ¯
npx wrangler d1 info simple-blog-db
```

#### 1.3 åˆå§‹åŒ–æ•°æ®åº“ç»“æ„ï¼ˆæœ¬åœ°ï¼‰
```bash
# åœ¨æœ¬åœ°ç¯å¢ƒåˆå§‹åŒ–æ•°æ®åº“
npx wrangler d1 execute simple-blog-db --file=./simple_blog_database.sql --local

# æˆåŠŸè¾“å‡ºç¤ºä¾‹ï¼š
# ğŸŒ€ Mapping SQL input into an array of statements
# ğŸŒ€ Executing on local database simple-blog-db
# âœ… Executed 15 statements in 2ms
```

#### 1.4 éªŒè¯æœ¬åœ°æ•°æ®åº“
```bash
# æŸ¥è¯¢æœ¬åœ°æ•°æ®åº“ä¸­çš„è¡¨
npx wrangler d1 execute simple-blog-db --command="SELECT name FROM sqlite_master WHERE type='table';" --local

# æŸ¥è¯¢ç¤ºä¾‹æ•°æ®
npx wrangler d1 execute simple-blog-db --command="SELECT * FROM posts LIMIT 2;" --local

# æŸ¥è¯¢åˆ†ç±»æ•°æ®
npx wrangler d1 execute simple-blog-db --command="SELECT * FROM categories;" --local
```

### ç¬¬äºŒæ­¥ï¼šæœ¬åœ° Worker æµ‹è¯•

#### 2.1 å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨
```bash
# å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ
npm run dev
# æˆ–è€…
npx wrangler dev simple_blog_worker.js --local --persist

# æˆåŠŸè¾“å‡ºç¤ºä¾‹ï¼š
# â›…ï¸ wrangler 3.x.x
# ------------------
# Your worker has access to the following bindings:
# - D1 Databases:
#   - DB: simple-blog-db
# â” Starting local server...
# [mf:inf] Ready on http://localhost:8787
```

#### 2.2 API ç«¯ç‚¹æµ‹è¯•
æ‰“å¼€æ–°çš„ç»ˆç«¯çª—å£ï¼Œæ‰§è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

```bash
# æµ‹è¯•è·å–å¸–å­åˆ—è¡¨
curl "http://localhost:8787/api/posts"

# æµ‹è¯•è·å–å•ä¸ªå¸–å­
curl "http://localhost:8787/api/posts/1"

# æµ‹è¯•åˆ›å»ºæ–°å¸–å­
curl -X POST "http://localhost:8787/api/posts" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "æµ‹è¯•æ–‡ç« ",
    "content": "è¿™æ˜¯ä¸€ç¯‡æµ‹è¯•æ–‡ç« çš„å†…å®¹",
    "author": "æµ‹è¯•ç”¨æˆ·",
    "slug": "test-post-$(date +%s)",
    "status": "published",
    "excerpt": "æµ‹è¯•æ–‡ç« æ‘˜è¦"
  }'

# æµ‹è¯•åˆ†é¡µåŠŸèƒ½
curl "http://localhost:8787/api/posts?page=1&limit=1"

# æµ‹è¯•çŠ¶æ€ç­›é€‰
curl "http://localhost:8787/api/posts?status=published"
```

### ç¬¬ä¸‰æ­¥ï¼šç”Ÿäº§ç¯å¢ƒæµ‹è¯•

#### 3.1 åˆå§‹åŒ–ç”Ÿäº§æ•°æ®åº“
```bash
# åœ¨ç”Ÿäº§ç¯å¢ƒåˆå§‹åŒ–æ•°æ®åº“
npx wrangler d1 execute simple-blog-db --file=./simple_blog_database.sql --remote

# éªŒè¯ç”Ÿäº§æ•°æ®åº“
npx wrangler d1 execute simple-blog-db --command="SELECT COUNT(*) as post_count FROM posts;" --remote
```

#### 3.2 éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
```bash
# éƒ¨ç½² Worker åˆ°ç”Ÿäº§ç¯å¢ƒ
npm run deploy
# æˆ–è€…
npx wrangler deploy simple_blog_worker.js

# æˆåŠŸè¾“å‡ºç¤ºä¾‹ï¼š
# âœ¨ Successfully published your worker to
# https://simple-blog-api.your-subdomain.workers.dev
```

#### 3.3 ç”Ÿäº§ç¯å¢ƒAPIæµ‹è¯•
```bash
# æ›¿æ¢ä¸ºä½ çš„å®é™… Worker URL
WORKER_URL="https://simple-blog-api.your-subdomain.workers.dev"

# æµ‹è¯•ç”Ÿäº§ç¯å¢ƒAPI
curl "$WORKER_URL/api/posts"
curl "$WORKER_URL/api/posts/1"

# åˆ›å»ºç”Ÿäº§ç¯å¢ƒæµ‹è¯•æ•°æ®
curl -X POST "$WORKER_URL/api/posts" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "ç”Ÿäº§ç¯å¢ƒæµ‹è¯•æ–‡ç« ",
    "content": "è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„æµ‹è¯•æ–‡ç« ",
    "author": "ç”Ÿäº§æµ‹è¯•å‘˜",
    "slug": "production-test-$(date +%s)",
    "status": "published",
    "excerpt": "ç”Ÿäº§ç¯å¢ƒæµ‹è¯•"
  }'
```

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæ•°æ®åº“æƒé™é”™è¯¯
```bash
# æ£€æŸ¥æƒé™
npx wrangler whoami

# é‡æ–°ç™»å½•
npx wrangler login
```

### é—®é¢˜2ï¼šæ•°æ®åº“æœªæ‰¾åˆ°
```bash
# æ£€æŸ¥ wrangler.toml é…ç½®
cat wrangler.toml

# éªŒè¯æ•°æ®åº“IDæ˜¯å¦æ­£ç¡®
npx wrangler d1 info simple-blog-db
```

### é—®é¢˜3ï¼šæœ¬åœ°å¼€å‘ç¯å¢ƒé—®é¢˜
```bash
# æ¸…ç†æœ¬åœ°ç¼“å­˜
rm -rf .wrangler

# é‡æ–°å¯åŠ¨å¼€å‘ç¯å¢ƒ
npx wrangler dev simple_blog_worker.js --local --persist
```

### é—®é¢˜4ï¼šSQL æ‰§è¡Œå¤±è´¥
```bash
# æ£€æŸ¥ SQL æ–‡ä»¶è¯­æ³•
cat simple_blog_database.sql

# é€æ­¥æ‰§è¡Œ SQL è¯­å¥
npx wrangler d1 execute simple-blog-db --command="CREATE TABLE IF NOT EXISTS test (id INTEGER);" --local
```

## æ€§èƒ½æµ‹è¯•

### åŸºç¡€æ€§èƒ½æµ‹è¯•
```bash
# å®‰è£…æ€§èƒ½æµ‹è¯•å·¥å…·
npm install -g autocannon

# æµ‹è¯•è·å–å¸–å­åˆ—è¡¨æ€§èƒ½
autocannon -c 10 -d 10 http://localhost:8787/api/posts

# æµ‹è¯•åˆ›å»ºå¸–å­æ€§èƒ½
autocannon -c 5 -d 5 -m POST \
  -H "Content-Type: application/json" \
  -b '{"title":"æ€§èƒ½æµ‹è¯•","content":"æµ‹è¯•å†…å®¹","author":"æµ‹è¯•","slug":"perf-test","status":"published"}' \
  http://localhost:8787/api/posts
```

## æˆåŠŸæ ‡å‡†

### æœ¬åœ°ç¯å¢ƒæˆåŠŸæ ‡å‡†
- âœ… D1 æ•°æ®åº“åˆ›å»ºæˆåŠŸ
- âœ… æœ¬åœ°æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
- âœ… æœ¬åœ° Worker å¯åŠ¨æˆåŠŸ
- âœ… æ‰€æœ‰ API ç«¯ç‚¹è¿”å›æ­£ç¡®å“åº”
- âœ… CRUD æ“ä½œæ­£å¸¸å·¥ä½œ

### ç”Ÿäº§ç¯å¢ƒæˆåŠŸæ ‡å‡†
- âœ… ç”Ÿäº§æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
- âœ… Worker éƒ¨ç½²æˆåŠŸ
- âœ… ç”Ÿäº§ç¯å¢ƒ API å¯æ­£å¸¸è®¿é—®
- âœ… æ•°æ®æŒä¹…åŒ–æ­£å¸¸
- âœ… æ€§èƒ½æ»¡è¶³è¦æ±‚ï¼ˆå“åº”æ—¶é—´ < 500msï¼‰

## ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹ Worker æ—¥å¿—
npx wrangler tail

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´æ®µçš„æ—¥å¿—
npx wrangler tail --since 1h
```

### æ•°æ®åº“ç›‘æ§
```bash
# æŸ¥çœ‹æ•°æ®åº“ä½¿ç”¨æƒ…å†µ
npx wrangler d1 info simple-blog-db

# æ‰§è¡Œç»´æŠ¤æŸ¥è¯¢
npx wrangler d1 execute simple-blog-db --command="PRAGMA table_info(posts);" --remote
```

## æ•…éšœæ¢å¤

### æ•°æ®å¤‡ä»½
```bash
# å¯¼å‡ºç”Ÿäº§æ•°æ®
npx wrangler d1 execute simple-blog-db --command="SELECT * FROM posts;" --remote --output backup-posts.json

# å¯¼å‡ºæ•°æ®åº“ç»“æ„
npx wrangler d1 execute simple-blog-db --command=".schema" --remote
```

### å›æ»šç­–ç•¥
```bash
# å›æ»šåˆ°ä¹‹å‰çš„ Worker ç‰ˆæœ¬
npx wrangler rollback

# é‡æ–°åˆå§‹åŒ–æ•°æ®åº“ï¼ˆæ…ç”¨ï¼‰
npx wrangler d1 execute simple-blog-db --file=./simple_blog_database.sql --remote
```

é€šè¿‡å®Œæˆä»¥ä¸Šæ‰€æœ‰æµ‹è¯•æ­¥éª¤ï¼Œä½ å°±å¯ä»¥ç¡®ä¿¡ Cloudflare D1 åœ¨ä½ çš„é¡¹ç›®ä¸­å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚
