# ğŸ”’ å®‰å…¨æ€§æ£€æŸ¥æŠ¥å‘Š

## ğŸ“Š å®‰å…¨è¯„ä¼°æ€»ç»“

**æ€»ä½“å®‰å…¨ç­‰çº§**: ğŸŸ¡ **ä¸­ç­‰** (éœ€è¦æ”¹è¿›)  
**å…³é”®å®‰å…¨é—®é¢˜**: 3ä¸ª  
**å»ºè®®æ”¹è¿›é¡¹**: 5ä¸ª  
**ç«‹å³éœ€è¦ä¿®å¤**: 2ä¸ª  

## ğŸš¨ å…³é”®å®‰å…¨é—®é¢˜

### 1. **CORS é…ç½®è¿‡äºå®½æ¾** - ğŸ”´ é«˜é£é™©
**é—®é¢˜**: `Access-Control-Allow-Origin: '*'` å…è®¸ä»»ä½•åŸŸåè®¿é—®
```javascript
// å½“å‰é…ç½® (ä¸å®‰å…¨)
'Access-Control-Allow-Origin': '*'
```

**é£é™©**: 
- ä»»ä½•ç½‘ç«™éƒ½èƒ½è°ƒç”¨ä½ çš„API
- å¯èƒ½è¢«æ¶æ„ç½‘ç«™æ»¥ç”¨
- æ•°æ®æ³„éœ²é£é™©

**ä¿®å¤å»ºè®®**:
```javascript
// å®‰å…¨çš„é…ç½®
const allowedOrigins = [
  'https://huaman-lou.top',
  'https://api.huaman-lou.top',
  'https://simple-blog-api.gudaobaiyun12.workers.dev'
];

const origin = request.headers.get('Origin');
const corsHeaders = {
  'Access-Control-Allow-Origin': allowedOrigins.includes(origin) ? origin : 'null',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization',
};
```

### 2. **ç¼ºå°‘èº«ä»½éªŒè¯å’Œæˆæƒ** - ğŸ”´ é«˜é£é™©
**é—®é¢˜**: API å®Œå…¨å¼€æ”¾ï¼Œä»»ä½•äººéƒ½å¯ä»¥åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ–‡ç« 

**é£é™©**:
- æ¶æ„ç”¨æˆ·å¯ä»¥åˆ é™¤æ‰€æœ‰æ–‡ç« 
- åƒåœ¾å†…å®¹æ³¨å…¥
- æ•°æ®å®Œæ•´æ€§å—æŸ

**ä¿®å¤å»ºè®®**:
```javascript
// æ·»åŠ ç®€å•çš„APIå¯†é’¥éªŒè¯
async function authenticate(request) {
  const apiKey = request.headers.get('X-API-Key');
  const validApiKey = 'YOUR_API_SECRET_HERE'; // åº”è¯¥ä»ç¯å¢ƒå˜é‡è¯»å–
  
  if (!apiKey || apiKey !== validApiKey) {
    return new Response('Unauthorized', { status: 401 });
  }
  return null; // éªŒè¯é€šè¿‡
}

// åœ¨éœ€è¦çš„æ“ä½œå‰æ·»åŠ éªŒè¯
if (pathname === '/api/posts' && ['POST', 'PUT', 'DELETE'].includes(method)) {
  const authError = await authenticate(request);
  if (authError) return authError;
}
```

### 3. **è¾“å…¥éªŒè¯ä¸è¶³** - ğŸŸ¡ ä¸­é£é™©
**é—®é¢˜**: ç¼ºå°‘å¯¹è¾“å…¥å†…å®¹çš„å®‰å…¨éªŒè¯

**é£é™©**:
- XSS æ”»å‡»
- SQL æ³¨å…¥ (è™½ç„¶ä½¿ç”¨äº†å‚æ•°åŒ–æŸ¥è¯¢ï¼Œä½†ä»éœ€éªŒè¯)
- æ¶æ„å†…å®¹å­˜å‚¨

**ä¿®å¤å»ºè®®**:
```javascript
// æ·»åŠ è¾“å…¥sanitization
function sanitizeInput(input) {
  if (typeof input !== 'string') return input;
  
  return input
    .replace(/[<>]/g, '') // ç§»é™¤HTMLæ ‡ç­¾
    .substring(0, 10000)  // é™åˆ¶é•¿åº¦
    .trim();
}

// éªŒè¯slugæ ¼å¼
function isValidSlug(slug) {
  return /^[a-z0-9-]+$/.test(slug);
}
```

## âš ï¸ å®‰å…¨æ”¹è¿›å»ºè®®

### 4. **ç¼ºå°‘é€Ÿç‡é™åˆ¶** - ğŸŸ¡ ä¸­é£é™©
**é—®é¢˜**: æ²¡æœ‰é˜²æ­¢APIæ»¥ç”¨çš„æœºåˆ¶

**å½±å“**: å¯èƒ½è¢«DDoSæ”»å‡»æˆ–æ¶æ„åˆ·æ¥å£

**å»ºè®®**: ä½¿ç”¨ Cloudflare çš„é€Ÿç‡é™åˆ¶åŠŸèƒ½

### 5. **æ•æ„Ÿä¿¡æ¯æš´éœ²** - ğŸŸ¡ ä¸­é£é™©
**é—®é¢˜**: é”™è¯¯ä¿¡æ¯å¯èƒ½æš´éœ²ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯

**ä¿®å¤**:
```javascript
// ä¸è¦æš´éœ²è¯¦ç»†é”™è¯¯
return new Response(JSON.stringify({ error: 'Internal server error' }), {
  status: 500,
  headers: corsHeaders
});
```

### 6. **ç¼ºå°‘HTTPSå¼ºåˆ¶** - ğŸŸ¡ ä¸­é£é™©
**å»ºè®®**: ç¡®ä¿æ‰€æœ‰APIè°ƒç”¨éƒ½é€šè¿‡HTTPS

### 7. **æ•°æ®åº“è®¿é—®æ§åˆ¶** - ğŸŸ¢ ä½é£é™©
**å½“å‰çŠ¶æ€**: ä½¿ç”¨äº†å‚æ•°åŒ–æŸ¥è¯¢ï¼Œè¾ƒä¸ºå®‰å…¨
**å»ºè®®**: æ·»åŠ æ›´ä¸¥æ ¼çš„æƒé™æ§åˆ¶

## ğŸ›¡ï¸ ç«‹å³ä¿®å¤çš„å®‰å…¨è¡¥ä¸

### è¡¥ä¸ 1: å®‰å…¨çš„CORSé…ç½®
```javascript
// æ·»åŠ åˆ° Worker é¡¶éƒ¨
const ALLOWED_ORIGINS = [
  'https://huaman-lou.top',
  'https://api.huaman-lou.top',
  'https://simple-blog-api.gudaobaiyun12.workers.dev',
  'http://localhost:8787' // ä»…å¼€å‘ç¯å¢ƒ
];

function getCorsHeaders(request) {
  const origin = request.headers.get('Origin');
  const isAllowed = ALLOWED_ORIGINS.includes(origin);
  
  return {
    'Access-Control-Allow-Origin': isAllowed ? origin : 'null',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, X-API-Key',
    'Access-Control-Max-Age': '86400',
  };
}
```

### è¡¥ä¸ 2: åŸºç¡€èº«ä»½éªŒè¯
```javascript
// æ·»åŠ ç¯å¢ƒå˜é‡åˆ° wrangler.toml
[vars]
API_SECRET = "your-secure-api-key-here"

// åœ¨ Worker ä¸­æ·»åŠ éªŒè¯å‡½æ•°
async function requireAuth(request, env) {
  const apiKey = request.headers.get('X-API-Key');
  
  if (!apiKey || apiKey !== env.API_SECRET) {
    return new Response(JSON.stringify({ error: 'Unauthorized' }), {
      status: 401,
      headers: { 'Content-Type': 'application/json' }
    });
  }
  return null;
}
```

## ğŸ“‹ å®‰å…¨æ£€æŸ¥æ¸…å•

### âœ… å·²å®ç°çš„å®‰å…¨æªæ–½
- [x] å‚æ•°åŒ–æ•°æ®åº“æŸ¥è¯¢
- [x] åŸºæœ¬è¾“å…¥éªŒè¯ (å¿…éœ€å­—æ®µ)
- [x] HTTPS æ”¯æŒ (é€šè¿‡ Cloudflare)
- [x] é”™è¯¯å¤„ç†

### âŒ éœ€è¦æ·»åŠ çš„å®‰å…¨æªæ–½
- [ ] CORS ç™½åå•
- [ ] API èº«ä»½éªŒè¯
- [ ] è¾“å…¥å†…å®¹è¿‡æ»¤
- [ ] é€Ÿç‡é™åˆ¶
- [ ] æ—¥å¿—è®°å½•
- [ ] å†…å®¹é•¿åº¦é™åˆ¶
- [ ] æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

## ğŸ”§ æ¨èçš„å®‰å…¨é…ç½®

### Cloudflare Dashboard è®¾ç½®
1. **é€Ÿç‡é™åˆ¶**:
   - è·¯å¾„: `Security` â†’ `Rate Limiting`
   - è§„åˆ™: æ¯IPæ¯åˆ†é’Ÿæœ€å¤š30ä¸ªè¯·æ±‚

2. **WAFè§„åˆ™**:
   - å¯ç”¨ "OWASP ModSecurity Core Rule Set"
   - æ·»åŠ è‡ªå®šä¹‰è§„åˆ™é˜²æ­¢æ¶æ„è¯·æ±‚

3. **SSL/TLS**:
   - æ¨¡å¼: "Full (strict)"
   - æœ€å°TLSç‰ˆæœ¬: 1.2
   - å¯ç”¨ "Always Use HTTPS"

### ç¯å¢ƒå˜é‡å®‰å…¨
```toml
# wrangler.toml
[vars]
ENVIRONMENT = "production"
API_VERSION = "v1"

# æ•æ„Ÿä¿¡æ¯åº”è¯¥ç”¨ wrangler secret
# wrangler secret put API_SECRET
# wrangler secret put DB_ENCRYPTION_KEY
```

## ğŸ¯ å®‰å…¨ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ (ç«‹å³ä¿®å¤)
1. ä¿®å¤ CORS é…ç½®
2. æ·»åŠ  API èº«ä»½éªŒè¯

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ (ä¸€å‘¨å†…)
3. åŠ å¼ºè¾“å…¥éªŒè¯
4. æ·»åŠ é€Ÿç‡é™åˆ¶
5. æ”¹è¿›é”™è¯¯å¤„ç†

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ (é•¿æœŸ)
6. æ·»åŠ å®¡è®¡æ—¥å¿—
7. å®ç°æ›´å¤æ‚çš„æƒé™ç³»ç»Ÿ

## ğŸ’¡ å®‰å…¨æœ€ä½³å®è·µå»ºè®®

1. **å®šæœŸå®‰å…¨å®¡è®¡**: æ¯æœˆæ£€æŸ¥ä¸€æ¬¡
2. **ç›‘æ§å¼‚å¸¸æ´»åŠ¨**: è®¾ç½®å‘Šè­¦
3. **å¤‡ä»½ç­–ç•¥**: å®šæœŸå¤‡ä»½æ•°æ®åº“
4. **æ›´æ–°ä¾èµ–**: ä¿æŒ Wrangler å’Œä¾èµ–æœ€æ–°
5. **å®‰å…¨åŸ¹è®­**: äº†è§£æœ€æ–°çš„å®‰å…¨å¨èƒ

## ğŸ“ å¦‚éœ€å¸®åŠ©

å¦‚æœéœ€è¦å®æ–½è¿™äº›å®‰å…¨æªæ–½ï¼Œæˆ‘å¯ä»¥ï¼š
1. åˆ›å»ºå®‰å…¨è¡¥ä¸æ–‡ä»¶
2. æ›´æ–° Worker ä»£ç 
3. é…ç½® Cloudflare å®‰å…¨è®¾ç½®
4. åˆ›å»ºå®‰å…¨æµ‹è¯•è„šæœ¬

**ç»“è®º**: è™½ç„¶å­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œä½†éƒ½æ˜¯å¯ä»¥ä¿®å¤çš„ã€‚å»ºè®®ç«‹å³å®æ–½é«˜ä¼˜å…ˆçº§çš„å®‰å…¨æªæ–½ã€‚
